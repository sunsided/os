<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Advanced Programmable Interrupt Controller (APIC) Support"><title>kernel::apic - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../../static.files/rustdoc-ca0dd0c4.css"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="kernel" data-themes="" data-resource-suffix="" data-rustdoc-version="1.93.0-nightly (b6d7ff3aa 2025-11-14)" data-channel="nightly" data-search-js="search-680b2199.js" data-stringdex-js="stringdex-c3e638e9.js" data-settings-js="settings-c38705f0.js" ><script src="../../static.files/storage-e2aeef58.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../static.files/main-a410ff4d.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-044be391.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar><h2><a href="#">Module apic</a></h2></rustdoc-topbar><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../kernel/index.html">kernel</a><span class="version">0.0.0</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Module apic</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#advanced-programmable-interrupt-controller-apic-support" title="Advanced Programmable Interrupt Controller (APIC) Support">Advanced Programmable Interrupt Controller (APIC) Support</a><ul><li><a href="#overview" title="Overview">Overview</a></li><li><a href="#key-features" title="Key Features">Key Features</a></li><li><a href="#architecture" title="Architecture">Architecture</a></li><li><a href="#initialization-sequence" title="Initialization Sequence">Initialization Sequence</a></li><li><a href="#timer-operation" title="Timer Operation">Timer Operation</a></li><li><a href="#safety" title="Safety">Safety</a></li></ul></li></ul><h3><a href="#modules">Module Items</a></h3><ul class="block"><li><a href="#modules" title="Modules">Modules</a></li><li><a href="#constants" title="Constants">Constants</a></li><li><a href="#functions" title="Functions">Functions</a></li></ul></section><div id="rustdoc-modnav"><h2 class="in-crate"><a href="../index.html">In crate kernel</a></h2></div></div></nav><div class="sidebar-resizer" title="Drag to resize sidebar"></div><main><div class="width-limiter"><section id="main-content" class="content"><div class="main-heading"><div class="rustdoc-breadcrumbs"><a href="../index.html">kernel</a></div><h1>Module <span>apic</span>&nbsp;<button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../src/kernel/apic.rs.html#1-283">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="advanced-programmable-interrupt-controller-apic-support"><a class="doc-anchor" href="#advanced-programmable-interrupt-controller-apic-support">Â§</a>Advanced Programmable Interrupt Controller (APIC) Support</h2>
<p>This module provides x2APIC (Extended x86 Advanced Programmable Interrupt Controller)
functionality for modern x86-64 systems. It handles Local APIC initialization,
timer configuration, and interrupt management for the kernel.</p>
<h3 id="overview"><a class="doc-anchor" href="#overview">Â§</a>Overview</h3>
<p>The x2APIC is the modern successor to the legacy xAPIC, providing improved performance
and scalability through MSR-based register access instead of memory-mapped I/O.
This implementation focuses on single-core operation with the Bootstrap Processor (BSP).</p>
<h3 id="key-features"><a class="doc-anchor" href="#key-features">Â§</a>Key Features</h3>
<ul>
<li><strong>x2APIC Mode</strong>: Enables and configures x2APIC mode for improved performance</li>
<li><strong>Timer Management</strong>: Configures periodic LAPIC timer for kernel scheduling</li>
<li><strong>Interrupt Handling</strong>: Manages spurious interrupts and End-of-Interrupt (EOI) signaling</li>
<li><strong>Calibration</strong>: TSC-based timer frequency calibration for accurate timing</li>
</ul>
<h3 id="architecture"><a class="doc-anchor" href="#architecture">Â§</a>Architecture</h3>
<p>The module operates through several key components:</p>
<h4 id="msr-interface"><a class="doc-anchor" href="#msr-interface">Â§</a>MSR Interface</h4>
<ul>
<li><a href="fn.rdmsr.html" title="fn kernel::apic::rdmsr"><code>rdmsr</code></a>/<a href="fn.wrmsr.html" title="fn kernel::apic::wrmsr"><code>wrmsr</code></a> - Low-level Model-Specific Register access functions</li>
<li>Direct manipulation of x2APIC MSRs (0x800-0x8FF range)</li>
</ul>
<h4 id="apic-management"><a class="doc-anchor" href="#apic-management">Â§</a>APIC Management</h4>
<ul>
<li><a href="fn.enable_and_read_id_x2apic.html" title="fn kernel::apic::enable_and_read_id_x2apic"><code>enable_and_read_id_x2apic</code></a> - Initializes x2APIC mode and reads APIC ID</li>
<li><a href="fn.write_svr_x2apic.html" title="fn kernel::apic::write_svr_x2apic"><code>write_svr_x2apic</code></a> - Configures Spurious Interrupt Vector Register</li>
<li><a href="fn.eoi_x2apic.html" title="fn kernel::apic::eoi_x2apic"><code>eoi_x2apic</code></a> - Signals End-of-Interrupt for completed interrupt processing</li>
</ul>
<h4 id="timer-subsystem"><a class="doc-anchor" href="#timer-subsystem">Â§</a>Timer Subsystem</h4>
<ul>
<li><a href="fn.program_timer_periodic_x2apic.html" title="fn kernel::apic::program_timer_periodic_x2apic"><code>program_timer_periodic_x2apic</code></a> - Configures LAPIC timer in periodic mode</li>
<li><a href="fn.calibrate_lapic_hz_via_tsc.html" title="fn kernel::apic::calibrate_lapic_hz_via_tsc"><code>calibrate_lapic_hz_via_tsc</code></a> - Calibrates timer frequency against TSC</li>
<li><a href="lapic_div/index.html" title="mod kernel::apic::lapic_div"><code>lapic_div</code></a> - Timer divider constants for frequency scaling</li>
</ul>
<h3 id="initialization-sequence"><a class="doc-anchor" href="#initialization-sequence">Â§</a>Initialization Sequence</h3>
<ol>
<li><strong>Capability Check</strong>: Verify x2APIC support via CPUID</li>
<li><strong>Mode Enable</strong>: Set <code>APIC_EN</code> and <code>APIC_EXTD</code> bits in <code>IA32_APIC_BASE</code> MSR</li>
<li><strong>ID Assignment</strong>: Read and store Local APIC ID in per-CPU structure</li>
<li><strong>Spurious Vector</strong>: Configure spurious interrupt handling</li>
<li><strong>Timer Setup</strong>: Calibrate and configure periodic timer operation</li>
</ol>
<h3 id="timer-operation"><a class="doc-anchor" href="#timer-operation">Â§</a>Timer Operation</h3>
<p>The LAPIC timer operates in periodic mode at 1 kHz frequency:</p>
<ul>
<li>Uses TSC-based calibration for accurate frequency measurement</li>
<li>Supports configurable clock dividers (1, 2, 4, 8, 16, 32, 64, 128)</li>
<li>Generates timer interrupts for kernel tick processing</li>
</ul>
<h3 id="safety"><a class="doc-anchor" href="#safety">Â§</a>Safety</h3>
<p>This module contains extensive unsafe code for:</p>
<ul>
<li>Direct MSR manipulation via <code>rdmsr</code>/<code>wrmsr</code> instructions</li>
<li>Hardware register configuration and timing-critical operations</li>
<li>Interrupt controller programming and state management</li>
</ul>
<p>All unsafe operations are necessary for hardware control and are carefully
isolated with documented safety requirements.</p>
</div></details><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">Â§</a></h2><dl class="item-table"><dt><a class="mod" href="lapic_div/index.html" title="mod kernel::apic::lapic_div">lapic_<wbr>div</a></dt></dl><h2 id="constants" class="section-header">Constants<a href="#constants" class="anchor">Â§</a></h2><dl class="item-table"><dt><a class="constant" href="constant.APIC_EN.html" title="constant kernel::apic::APIC_EN">APIC_EN</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </dt><dt><a class="constant" href="constant.APIC_EXTD.html" title="constant kernel::apic::APIC_EXTD">APIC_<wbr>EXTD</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </dt><dt><a class="constant" href="constant.IA32_APIC_BASE.html" title="constant kernel::apic::IA32_APIC_BASE">IA32_<wbr>APIC_<wbr>BASE</a></dt><dt><a class="constant" href="constant.IA32_X2APIC_DIVCONF.html" title="constant kernel::apic::IA32_X2APIC_DIVCONF">IA32_<wbr>X2APIC_<wbr>DIVCONF</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </dt><dt><a class="constant" href="constant.IA32_X2APIC_EOI.html" title="constant kernel::apic::IA32_X2APIC_EOI">IA32_<wbr>X2APIC_<wbr>EOI</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </dt><dt><a class="constant" href="constant.IA32_X2APIC_ID.html" title="constant kernel::apic::IA32_X2APIC_ID">IA32_<wbr>X2APIC_<wbr>ID</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </dt><dt><a class="constant" href="constant.IA32_X2APIC_INITCNT.html" title="constant kernel::apic::IA32_X2APIC_INITCNT">IA32_<wbr>X2APIC_<wbr>INITCNT</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </dt><dt><a class="constant" href="constant.IA32_X2APIC_LVT_TIMER.html" title="constant kernel::apic::IA32_X2APIC_LVT_TIMER">IA32_<wbr>X2APIC_<wbr>LVT_<wbr>TIMER</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </dt><dt><a class="constant" href="constant.IA32_X2APIC_SVR.html" title="constant kernel::apic::IA32_X2APIC_SVR">IA32_<wbr>X2APIC_<wbr>SVR</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </dt></dl><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">Â§</a></h2><dl class="item-table"><dt><a class="fn" href="fn.calibrate_lapic_hz_via_tsc.html" title="fn kernel::apic::calibrate_lapic_hz_via_tsc">calibrate_<wbr>lapic_<wbr>hz_<wbr>via_<wbr>tsc</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> <sup title="unsafe function">âš </sup></dt><dt><a class="fn" href="fn.enable_and_read_id_x2apic.html" title="fn kernel::apic::enable_and_read_id_x2apic">enable_<wbr>and_<wbr>read_<wbr>id_<wbr>x2apic</a><sup title="unsafe function">âš </sup></dt><dd>Enable x2APIC and return the Local APIC ID.
Panics if x2APIC isnâ€™t supported.</dd><dt><a class="fn" href="fn.eoi_x2apic.html" title="fn kernel::apic::eoi_x2apic">eoi_<wbr>x2apic</a><sup title="unsafe function">âš </sup></dt><dd>Signal End-of-Interrupt.</dd><dt><a class="fn" href="fn.init_lapic_and_set_cpu_id.html" title="fn kernel::apic::init_lapic_and_set_cpu_id">init_<wbr>lapic_<wbr>and_<wbr>set_<wbr>cpu_<wbr>id</a></dt><dd>Bring up x2APIC on the BSP and record the APIC ID in <code>PerCpu</code>.</dd><dt><a class="fn" href="fn.lapic_enable_spurious_vector.html" title="fn kernel::apic::lapic_enable_spurious_vector">lapic_<wbr>enable_<wbr>spurious_<wbr>vector</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> </dt><dt><a class="fn" href="fn.mask_timer_x2apic.html" title="fn kernel::apic::mask_timer_x2apic">mask_<wbr>timer_<wbr>x2apic</a><sup title="unsafe function">âš </sup></dt><dt><a class="fn" href="fn.program_timer_periodic_x2apic.html" title="fn kernel::apic::program_timer_periodic_x2apic">program_<wbr>timer_<wbr>periodic_<wbr>x2apic</a><sup title="unsafe function">âš </sup></dt><dd>Program the LAPIC timer in periodic mode (x2APIC).</dd><dt><a class="fn" href="fn.rdmsr.html" title="fn kernel::apic::rdmsr">rdmsr</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> <sup title="unsafe function">âš </sup></dt><dt><a class="fn" href="fn.start_lapic_timer.html" title="fn kernel::apic::start_lapic_timer">start_<wbr>lapic_<wbr>timer</a></dt><dd>Quick helper to start a periodic timer (coarse values; calibrate later).</dd><dt><a class="fn" href="fn.write_svr_x2apic.html" title="fn kernel::apic::write_svr_x2apic">write_<wbr>svr_<wbr>x2apic</a><sup title="unsafe function">âš </sup></dt><dd>Set the Spurious Interrupt Vector register and software-enable the LAPIC.</dd><dt><a class="fn" href="fn.wrmsr.html" title="fn kernel::apic::wrmsr">wrmsr</a><span title="Restricted Visibility">&nbsp;ðŸ”’</span> <sup title="unsafe function">âš </sup></dt><dt><a class="fn" href="fn.x2apic_id.html" title="fn kernel::apic::x2apic_id">x2apic_<wbr>id</a></dt></dl></section></div></main></body></html>