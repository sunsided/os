version: '3'

# Load environment from these files if present (later wins).
dotenv: [ '.env.local', '.env' ]

# Global variables with sensible defaults; override via env or CLI:
#   task qemu ARGS='-d int' OVMF_DIR=/custom/path
vars:
  # Build profile switching
  PROFILE: '{{ .PROFILE | default "debug" }}'                # accepts: debug|release
  PROFILE_FLAG: '{{ if eq .PROFILE "release" }}--release{{ end }}'
  PROFILE_DIR: '{{ if eq .PROFILE "release" }}release{{ else }}debug{{ end }}'

  # These locations and file names vary per distribution.
  # You can try to find them using `task ovmf:find`.
  OVMF_DIR: '{{ .OVMF_DIR | default "/usr/share/OVMF" }}'
  OVMF_CODE_FILE: '{{ .OVMF_CODE_FILE | default "OVMF_CODE_4M.fd" }}'
  OVMF_VARS_FILE: '{{ .OVMF_VARS_FILE | default "OVMF_VARS_4M.fd" }}'

  # Where to put the files for QEMU
  BUILD_LOCAL_DIR: '{{ .BUILD_LOCAL_DIR | default "qemu" }}'

  # Path to the esp directory for QEMU
  ESP_LOCAL_DIR: '{{ printf "%s/esp" .BUILD_LOCAL_DIR }}'
  ESP_LOCAL_UEFI_PATH: '{{ printf "%s/EFI/Boot/BootX64.efi" .ESP_LOCAL_DIR}}'
  ESP_LOCAL_KERNEL_PATH: '{{ printf "%s/EFI/Boot/kernel.elf" .ESP_LOCAL_DIR}}'

  # Derived paths
  OVMF_CODE_PATH: '{{ printf "%s/%s" .OVMF_DIR .OVMF_CODE_FILE }}'
  OVMF_VARS_PATH: '{{ printf "%s/%s" .OVMF_DIR .OVMF_VARS_FILE }}'
  OVMF_LOCAL_VARS_PATH: '{{ printf "%s/%s" .BUILD_LOCAL_DIR "uefi-vars.fd" }}'

  # Target triples
  UEFI_TARGET_TRIPLE: 'x86_64-unknown-uefi'
  NONE_TARGET_TRIPLE: 'x86_64-unknown-none'
  HOST_TARGET:
    sh: "rustc -vV | grep host: | cut -d' ' -f2"

  # Where your .efi lives; tweak as needed
  UEFI_LOADER_PATH: '{{ printf "target/%s/%s/uefi-loader.efi" .UEFI_TARGET_TRIPLE .PROFILE }}'
  KERNEL_BIN_PATH: '{{ printf "target/%s/%s/kernel" .NONE_TARGET_TRIPLE .PROFILE }}'

# Default task when you run just `task`
tasks:
  default:
    desc: Show common tasks
    cmds:
      - task -l

  setup:
    desc: Install required Rust targets and verify toolchain setup
    cmds:
      - |
        required_targets=(
          "{{.UEFI_TARGET_TRIPLE}}"
          "{{.NONE_TARGET_TRIPLE}}"
        )
        for target in "${required_targets[@]}"; do
          if rustup target list --installed | grep -q "$target"; then
            echo "✓ $target already installed"
          else
            echo "→ Installing $target..."
            rustup target add "$target"
          fi
        done
      - rustup component add rust-src || true
      - cargo install --locked cargo-sort
      - echo "Rust setup complete."
      - pre-commit install
    preconditions:
      - sh: command -v rustup
        msg: "rustup not found — please install Rust via rustup.rs"
      - sh: command -v pre-commit
        msg: "pre-commit not found — please install"

  fmt:
    desc: Format all workspace crates
    sources:
      - Cargo.toml
      - os/kernel/**
      - os/uefi/**
      - os/utils/**
    cmds:
      - cargo fmt --all
      - task: todo

  todo:
    desc: Regenerates TODO.md
    sources:
      - os/kernel/**
      - os/uefi/**
      - os/utils/**
    cmds:
      - scripts/update-todos.sh
    generates:
      - TODO.md

  clippy:
    desc: Lint all workspace crates (deny warnings)
    cmds:
      - scripts/clippy-lint.sh

  clippy:fix:
    desc: Lint all workspace crates (deny warnings)
    aliases:
      - fix
    cmds:
      - scripts/clippy-fix.sh

  docs:build:
    desc: Build workspace docs (no-deps) into target/doc
    aliases:
      - doc
      - docs
    sources:
      - Cargo.toml
      - os/kernel/**
      - os/uefi/**
      - os/utils/**
    cmds:
      - cargo doc --workspace --no-deps
    generates:
      - target/doc

  docs:open:
    desc: Build workspace docs (no-deps) into target/doc
    aliases:
      - doc:open
    sources:
      - Cargo.toml
      - os/kernel/**
      - os/uefi/**
      - os/utils/**
    cmds:
      - cargo doc --workspace --no-deps --open
    generates:
      - target/doc

  test:
    desc: Run full test suite (doc + libs)
    deps:
      - test:docs
      - test:libs

  test:docs:
    desc: Run documentation tests only
    aliases:
      - test:doc
    cmds:
      - cargo test --doc --target {{.HOST_TARGET}}

  test:libs:
    desc: Run library tests (all targets)
    aliases:
      - test:lib
    cmds:
      - cargo test --all-features --lib --target {{.HOST_TARGET}}

  clean:
    desc: Clean cargo and build artifacts
    aliases:
      - clear
    deps:
      - clean:rust
      - clean:package

  clean:rust:
    desc: Clean cargo and build artifacts
    status:
      - |
        if command -v jq >/dev/null 2>&1; then
          test ! -d "$(cargo metadata --no-deps --format-version 1 | jq -r '.target_directory')"
        else
          false # force run if jq is missing (can't check status)
        fi
    cmds:
      - cargo clean

  clean:package:
    desc: Clean artifacts in {{.BUILD_LOCAL_DIR}}
    status:
      - test ! -d '{{.BUILD_LOCAL_DIR}}'
    cmds:
      - rm -rf '{{.BUILD_LOCAL_DIR}}'

  build:
    desc: Build UEFI loader and kernel
    cmds:
      - task: build:uefi
      - task: build:kernel
    requires:
      vars:
        - name: PROFILE
          enum:
            - debug
            - release

  build:kernel:
    desc: Build kernel (release, no std target)
    dir: os/kernel/kernel
    requires:
      vars:
        - name: PROFILE
          enum:
            - debug
            - release
    sources:
      - Cargo.toml
      - Cargo.lock
      - os/kernel/**
      - os/utils/**
    cmds:
      - cargo build --bin kernel --target '{{.NONE_TARGET_TRIPLE}}' {{.PROFILE_FLAG}}
      - task: kernel:elf
    generates:
      - '{{.KERNEL_BIN_PATH}}'

  kernel:elf:
    desc: Prints ELF information about {{.KERNEL_BIN_PATH}}
    requires:
      vars:
        - name: PROFILE
          enum:
            - debug
            - release
    cmds:
      - readelf -l {{.KERNEL_BIN_PATH}}
    preconditions:
      - sh: 'test -f "{{.KERNEL_BIN_PATH}}"'
        msg: '{{.KERNEL_BIN_PATH}} is missing; run task build:kernel'

  build:uefi:
    desc: Build UEFI loader (release)
    dir: os/uefi/uefi-loader
    requires:
      vars:
        - name: PROFILE
          enum:
            - debug
            - release
    sources:
      - Cargo.toml
      - Cargo.lock
      - os/uefi/**
      - os/utils/**
    cmds:
      - cargo build --bin uefi-loader --target '{{.UEFI_TARGET_TRIPLE}}' {{.PROFILE_FLAG}}
    generates:
      - '{{.UEFI_LOADER_PATH}}'

  package:
    desc: Prepare QEMU/OVMF runnable layout in {{.BUILD_LOCAL_DIR}} (ESP + vars)
    requires:
      vars:
        - name: PROFILE
          enum:
            - debug
            - release
    deps:
      - task: build
        vars:
          PROFILE: '{{.PROFILE}}'
    cmds:
      # Keep a writable copy of OVMF_VARS next to the build tree
      - mkdir -p '{{.BUILD_LOCAL_DIR}}'
      - |
        if [ ! -f '{{.OVMF_LOCAL_VARS_PATH}}' ]; then
          cp '{{.OVMF_VARS_PATH}}' '{{.OVMF_LOCAL_VARS_PATH}}'
        fi
      # Bundle the binaries
      - mkdir -p "$(dirname '{{.ESP_LOCAL_UEFI_PATH}}')"
      - mkdir -p "$(dirname '{{.ESP_LOCAL_KERNEL_PATH}}')"
      - cp '{{.UEFI_LOADER_PATH}}' '{{.ESP_LOCAL_UEFI_PATH}}'
      - cp '{{.KERNEL_BIN_PATH}}' '{{.ESP_LOCAL_KERNEL_PATH}}'
    sources:
      - '{{.UEFI_LOADER_PATH}}'
      - '{{.KERNEL_BIN_PATH}}'
      - '{{.OVMF_VARS_PATH}}'
    generates:
      - '{{.OVMF_LOCAL_VARS_PATH}}'
      - '{{.ESP_LOCAL_UEFI_PATH}}'
      - '{{.ESP_LOCAL_KERNEL_PATH}}'

  ovmf:find:
    desc: Try common OVMF locations and print the first that works
    cmds:
      - |
        for d in "{{.OVMF_DIR}}" /usr/share/OVMF /usr/share/edk2/ovmf /usr/share/edk2/x64 /usr/share/edk2-ovmf; do
          if [ -r "$d/OVMF_CODE.fd" ] || [ -r "$d/OVMF_CODE_4M.fd" ]; then
            echo "Found OVMF at: $d"; exit 0;
          fi
        done
        echo "No OVMF directory found." >&2; exit 1

  qemu:
    desc: Run with QEMU+OVMF + stdio serial + a display window
    requires:
      vars:
        - name: PROFILE
          enum:
            - debug
            - release
    deps:
      - task: package
        vars:
          PROFILE: '{{.PROFILE}}'
    env:
      QEMU: '{{ .QEMU | default "qemu-system-x86_64" }}'
    cmds:
      - |
        tail --pid="$$" -f debug.log &
        $QEMU \
          -machine q35 \
          -m 256 \
          -accel kvm -cpu host -smp 4 \
          -drive if=pflash,format=raw,readonly=on,file='{{.OVMF_CODE_PATH}}' \
          -drive if=pflash,format=raw,file='{{.OVMF_LOCAL_VARS_PATH}}' \
          -drive format=raw,file='fat:rw:{{.ESP_LOCAL_DIR}}' \
          -net none \
          -s \
          -debugcon file:debug.log -global isa-debugcon.iobase=0x402 \
          -monitor stdio \
          -no-reboot -no-shutdown -d cpu_reset \
          {{.CLI_ARGS}}
    preconditions:
      - sh: 'test -r "{{.OVMF_CODE_PATH}}"'
        msg: "OVMF code not found at {{.OVMF_CODE_PATH}} (override OVMF_DIR/OVMF_CODE_FILE)"
      - sh: 'test -r "{{.OVMF_LOCAL_VARS_PATH}}"'
        msg: "OVMF vars not found or not copied (run package)"
      - sh: 'test -d "{{.ESP_LOCAL_DIR}}"'
        msg: "ESP dir missing (run package)"
